# Turn on vacation mode when leaving the city
- id: vacation_mode_enable
  alias: Enable vacation mode
  mode: single
  trigger:
    - trigger: zone
      entity_id: person.sam
      zone: zone.san_francisco
      event: leave
  condition:
    - condition: state
      entity_id: input_boolean.vacation_mode
      state: "off"
  action:
    - action: input_boolean.turn_on
      target:
        entity_id: input_boolean.vacation_mode
    - action: notify.notify
      data:
        title: "ðŸŒ´ Vacation Mode Enabled"
        message: "Have a nice trip ðŸ‘‹"
        data:
          push:
            sound:
              name: default
          apns_headers:
            apns-collapse-id: vacation-mode

# Turn off vacation mode when entering the city
- id: vacation_mode_disable
  alias: Disable vacation mode
  mode: single
  trigger:
    - trigger: zone
      entity_id: person.sam
      zone: zone.san_francisco
      event: enter
  condition:
    - condition: state
      entity_id: input_boolean.vacation_mode
      state: "on"
  action:
    - action: input_boolean.turn_off
      target:
        entity_id: input_boolean.vacation_mode
    - action: notify.notify
      data:
        title: "ðŸ  Vacation Mode Disabled"
        message: "ðŸ‘‹ Welcome home!"
        data:
          push:
            sound:
              name: default
          apns_headers:
            apns-collapse-id: vacation-mode

# When an exterior door opens send a notification if vacation mode is on
- id: vacation_mode_alerts
  alias: Vacation mode alerts
  mode: single
  trigger:
    - trigger: numeric_state
      entity_id: sensor.open_doors_count
      above: 0
    - trigger: state
      entity_id: cover.garage_door
      to: "open"
  condition:
    - condition: state
      entity_id: input_boolean.vacation_mode
      state: "on"
  action:
    - action: notify.notify
      data:
        title: "ðŸš¨ Security Breach"
        message: >-
          {% if states("sensor.open_doors_count")|int > 0 %}{{ states("sensor.open_doors_count") }} open door{% if  states("sensor.open_doors_count")|int != 1 %}s{% endif %}. {% endif %}{% if states("cover.garage_door") == "open" %}Garage door is open.{% endif %}
        data:
          push:
            sound:
              name: default
              critical: 1
              volume: 1.0
          apns_headers:
            apns-collapse-id: vacation-mode-alert

- id: vacation_sunrise
  alias: Vacation - Sunrise
  mode: single
  trigger:
    - trigger: sun
      event: sunrise
  condition:
    - condition: state
      entity_id: input_boolean.vacation_mode
      state: "on"
  action:
    - action: scene.turn_on
      target:
        entity_id: scene.vacation_sunrise

- id: vacation_sunset
  alias: Vacation - Sunset
  mode: single
  trigger:
    - trigger: sun
      event: sunset
      offset: "00:45:00" # 45 minutes after sunset
  condition:
    - condition: state
      entity_id: input_boolean.vacation_mode
      state: "on"
  action:
    - action: scene.turn_on
      target:
        entity_id: scene.vacation_sunset

- id: vacation_night
  alias: Vacation - Night
  mode: single
  trigger:
    - trigger: time
      at: "22:00:00"
  condition:
    - condition: state
      entity_id: input_boolean.vacation_mode
      state: "on"
  action:
    - action: scene.turn_on
      target:
        entity_id: scene.vacation_night
