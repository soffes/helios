# Sensor

- id: doordash_order_placed
  alias: "DoorDash — Order Placed"
  mode: single
  trigger:
    - trigger: event
      event_type: imap_content
      event_data:
        sender: no-reply@doordash.com
  condition:
    - condition: template
      value_template: "{{ 'Order Confirmation for' in trigger.event.data.subject }}"
  action:
    - action: input_text.set_value
      target:
        entity_id: input_text.doordash_order_status
      data:
        value: "placed"
    - action: input_text.set_value
      target:
        entity_id: input_text.doordash_vendor
      data:
        value: >
          {{ trigger.event.data.subject.split(' from ')[1] }}

- id: doordash_order_delivered
  alias: "DoorDash — Order Delivered"
  mode: single
  trigger:
    - trigger: event
      event_type: imap_content
      event_data:
        sender: no-reply@doordash.com
  condition:
    - condition: template
      value_template: "{{ 'Details of your no-contact delivery' in trigger.event.data.subject }}"
  action:
    - action: input_text.set_value
      target:
        entity_id: input_text.doordash_order_status
      data:
        value: "delivered"

# TODO: Maybe only do this after the front door opens
- id: doordash_order_reset
  alias: "DoorDash — Reset to Inactive"
  mode: single
  trigger:
    - trigger: state
      entity_id: input_text.doordash_order_status
      to: "delivered"
      for:
        minutes: 5
  action:
    - action: input_text.set_value
      target:
        entity_id: input_text.doordash_order_status
      data:
        value: "inactive"
    - action: input_text.set_value
      target:
        entity_id: input_text.doordash_vendor
      data:
        value: ""

# Lights

- id: doordash_order_after_sunset_on
  alias: "DoorDash — Order After Sunset On"
  mode: single
  trigger:
    - trigger: state
      entity_id: sensor.doordash_order
      to: "placed"
  condition:
    - condition: sun
      after: sunset
  action:
    - action: scene.turn_on
      target:
        entity_id: scene.doordash_order_on

- id: doordash_order_after_sunset_off
  alias: "DoorDash — Order After Sunset Off"
  mode: single
  trigger:
    - trigger: state
      entity_id: sensor.doordash_order
      to: "idle"
  condition:
    - condition: sun
      after: sunset
  action:
    - action: scene.turn_on
      target:
        entity_id: scene.doordash_order_off
